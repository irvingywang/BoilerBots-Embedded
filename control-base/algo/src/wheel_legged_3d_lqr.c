#include "wheel_legged_3d_lqr.h"
#include <stdint.h>

// 
/**
 * 40 rows (K_ij), 6 columns (p00, p10, p01, p20, p11, p02)
 * p(x,y) = p00 + p10*x + p01*y + p20*x^2 + p11*x*y + p02*y^2
 * x is l_l (left leg length), y is l_r (right leg length)
 */
static const float K_Fit_Coefficients[40][6] = {
    -1.3634,  -6.4195,  6.0531,  12.239,  -5.1442,  -6.4679,
     -19.854,  -32.678,  88.903,  106.33,  -98.654,  -91.011,
     -29.366,  194.03,  -65.155,  -875.83,  -191.04,  154.17,
     -7.2551,  43.78,  -6.2948,  -140.8,  -29.87,  16.497,
     -58.795,  -82.963,  0.98233,  63.988,  38.748,  -8.3494,
     -2.2162,  -15.205,  4.1673,  -6.8384,  6.0288,  -6.6946,
     -1.6979,  22.576,  -25.942,  -46.379,  22.565,  -12.549,
     -0.22822,  -1.8792,  -2.4866,  6.8039,  -3.8412,  -0.28063,
     -85.115,  449.75,  -17.677,  -677.77,  51.532,  61.787,
     -5.1658,  12.623,  0.82606,  -11.232,  -1.6361,  1.5297,
     -1.3634,  6.0531,  -6.4195,  -6.4679,  -5.1442,  12.239,
     -19.854,  88.903,  -32.678,  -91.011,  -98.654,  106.33,
     29.366,  65.155,  -194.03,  -154.17,  191.04,  875.83,
     7.2551,  6.2948,  -43.78,  -16.497,  29.87,  140.8,
     -1.6979,  -25.942,  22.576,  -12.549,  22.565,  -46.379,
     -0.22822,  -2.4866,  -1.8792,  -0.28063,  -3.8412,  6.8039,
     -58.795,  0.98233,  -82.963,  -8.3494,  38.748,  63.988,
     -2.2162,  4.1673,  -15.205,  -6.6946,  6.0288,  -6.8384,
     -85.115,  -17.677,  449.75,  61.787,  51.532,  -677.77,
     -5.1658,  0.82606,  12.623,  1.5297,  -1.6361,  -11.232,
     0.14015,  -0.52385,  -0.22701,  1.8639,  0.75653,  -1.772,
     1.6472,  -4.7496,  -5.6946,  13.563,  10.947,  -8.5216,
     -59.089,  -17.142,  -32.298,  85.729,  48.081,  63.295,
     -10.993,  -1.9191,  -3.8339,  9.4579,  5.3548,  5.716,
     8.8059,  -21.323,  2.9298,  123.42,  36.971,  -9.3772,
     0.40512,  -4.1549,  0.090189,  16.985,  2.5306,  -1.2673,
     1.9869,  -2.4431,  -33.631,  7.4754,  -37.903,  -49.439,
     0.075024,  -0.51208,  1.4109,  1.5153,  -2.5863,  -14.354,
     -78.736,  -42.486,  6.0828,  39.19,  -1.0657,  28.637,
     -4.4463,  -1.4457,  0.45343,  -0.15014,  0.2886,  1.4709,
     0.14015,  -0.22701,  -0.52385,  -1.772,  0.75653,  1.8639,
     1.6472,  -5.6946,  -4.7496,  -8.5216,  10.947,  13.563,
     59.089,  32.298,  17.142,  -63.295,  -48.081,  -85.729,
     10.993,  3.8339,  1.9191,  -5.716,  -5.3548,  -9.4579,
     1.9869,  -33.631,  -2.4431,  -49.439,  -37.903,  7.4754,
     0.075024,  1.4109,  -0.51208,  -14.354,  -2.5863,  1.5153,
     8.8059,  2.9298,  -21.323,  -9.3772,  36.971,  123.42,
     0.40512,  0.090189,  -4.1549,  -1.2673,  2.5306,  16.985,
     -78.736,  6.0828,  -42.486,  28.637,  -1.0657,  39.19,
     -4.4463,  0.45343,  -1.4457,  1.4709,  0.2886,  -0.15014    ,
};

// Mapping from (i, j) to row index in K_Fit_Coefficients (0-based)
static const uint8_t K_index_map[4][10] = {
    {0, 1, 2, 3, 4, 5, 6, 7, 8, 9},        // Row 1: T_wl
    {10,11,12,13,14,15,16,17,18,19},       // Row 2: T_wr
    {20,21,22,23,24,25,26,27,28,29},       // Row 3: T_bl
    {30,31,32,33,34,35,36,37,38,39}        // Row 4: T_br
};

static float _Wheel_Legged_Evaluate_Kij(uint8_t row_index, float l_l, float l_r) {
    const float *coeff = K_Fit_Coefficients[row_index];
    return coeff[0]
         + coeff[1] * l_l
         + coeff[2] * l_r
         + coeff[3] * l_l * l_l
         + coeff[4] * l_l * l_r
         + coeff[5] * l_r * l_r;
}

void Wheel_Legged_Compute_LQR_output(const WheelLeggedState *state, float l_l, float l_r, WheelLeggedInput *input) {
    const float x[10] = {
        state->s, state->ds, state->phi, state->dphi,
        state->theta_ll, state->dtheta_ll, state->theta_lr, state->dtheta_lr,
        state->theta_b, state->dtheta_b
    };

    float u[4] = {0.0f, 0.0f, 0.0f, 0.0f};

    for (int i = 0; i < 4; ++i) {
        for (int j = 0; j < 10; ++j) {
            float Kij = evaluate_Kij(K_index_map[i][j], l_l, l_r);
            u[i] += -Kij * x[j];
        }
    }

    input->T_wl = u[0];
    input->T_wr = u[1];
    input->T_bl = u[2];
    input->T_br = u[3];
}