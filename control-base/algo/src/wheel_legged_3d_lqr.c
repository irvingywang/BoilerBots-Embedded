#include "wheel_legged_3d_lqr.h"
#include <stdint.h>

// 
/**
 * 40 rows (K_ij), 6 columns (p00, p10, p01, p20, p11, p02)
 * p(x,y) = p00 + p10*x + p01*y + p20*x^2 + p11*x*y + p02*y^2
 * x is l_l (left leg length), y is l_r (right leg length)
 */
static const float K_Fit_Coefficients[40][6] = {
    { -1.36342, -6.41948, 6.05308, 12.23947, -5.14415, -6.46791 },
{ -19.85365, -32.67761, 88.90298, 106.33215, -98.65382, -91.01060 },
{ -29.36619, 194.03163, -65.15477, -875.83377, -191.04287, 154.17176 },
{ -7.25507, 43.77994, -6.29475, -140.80160, -29.87049, 16.49729 },
{ -58.79490, -82.96296, 0.98233, 63.98825, 38.74831, -8.34941 },
{ -2.21620, -15.20522, 4.16729, -6.83842, 6.02876, -6.69455 },
{ -1.69787, 22.57606, -25.94231, -46.37851, 22.56538, -12.54873 },
{ -0.22822, -1.87922, -2.48659, 6.80391, -3.84123, -0.28063 },
{ -85.11481, 449.74542, -17.67692, -677.77143, 51.53198, 61.78710 },
{ -5.16575, 12.62309, 0.82606, -11.23173, -1.63613, 1.52970 },
{ -1.36342, 6.05308, -6.41948, -6.46791, -5.14415, 12.23947 },
{ -19.85365, 88.90298, -32.67761, -91.01060, -98.65382, 106.33215 },
{ 29.36619, 65.15477, -194.03163, -154.17176, 191.04287, 875.83377 },
{ 7.25507, 6.29475, -43.77994, -16.49729, 29.87049, 140.80160 },
{ -1.69787, -25.94231, 22.57606, -12.54873, 22.56538, -46.37851 },
{ -0.22822, -2.48659, -1.87922, -0.28063, -3.84123, 6.80391 },
{ -58.79490, 0.98233, -82.96296, -8.34941, 38.74831, 63.98825 },
{ -2.21620, 4.16729, -15.20522, -6.69455, 6.02876, -6.83842 },
{ -85.11481, -17.67692, 449.74542, 61.78710, 51.53198, -677.77143 },
{ -5.16575, 0.82606, 12.62309, 1.52970, -1.63613, -11.23173 },
{ 0.14015, -0.52385, -0.22701, 1.86388, 0.75653, -1.77201 },
{ 1.64715, -4.74960, -5.69464, 13.56306, 10.94686, -8.52159 },
{ -59.08877, -17.14151, -32.29821, 85.72856, 48.08133, 63.29526 },
{ -10.99316, -1.91911, -3.83388, 9.45791, 5.35478, 5.71598 },
{ 8.80587, -21.32347, 2.92983, 123.42065, 36.97087, -9.37721 },
{ 0.40512, -4.15492, 0.09019, 16.98481, 2.53063, -1.26732 },
{ 1.98686, -2.44308, -33.63061, 7.47538, -37.90315, -49.43872 },
{ 0.07502, -0.51208, 1.41088, 1.51531, -2.58627, -14.35439 },
{ -78.73608, -42.48622, 6.08276, 39.19032, -1.06569, 28.63673 },
{ -4.44633, -1.44566, 0.45343, -0.15014, 0.28860, 1.47089 },
{ 0.14015, -0.22701, -0.52385, -1.77201, 0.75653, 1.86388 },
{ 1.64715, -5.69464, -4.74960, -8.52159, 10.94686, 13.56306 },
{ 59.08877, 32.29821, 17.14151, -63.29526, -48.08133, -85.72856 },
{ 10.99316, 3.83388, 1.91911, -5.71598, -5.35478, -9.45791 },
{ 1.98686, -33.63061, -2.44308, -49.43872, -37.90315, 7.47538 },
{ 0.07502, 1.41088, -0.51208, -14.35439, -2.58627, 1.51531 },
{ 8.80587, 2.92983, -21.32347, -9.37721, 36.97087, 123.42065 },
{ 0.40512, 0.09019, -4.15492, -1.26732, 2.53063, 16.98481 },
{ -78.73608, 6.08276, -42.48622, 28.63673, -1.06569, 39.19032 },
{ -4.44633, 0.45343, -1.44566, 1.47089, 0.28860, -0.15014 },
};

// Mapping from (i, j) to row index in K_Fit_Coefficients (0-based)
static const uint8_t K_index_map[4][10] = {
    {0, 1, 2, 3, 4, 5, 6, 7, 8, 9},        // Row 1: T_wl
    {10,11,12,13,14,15,16,17,18,19},       // Row 2: T_wr
    {20,21,22,23,24,25,26,27,28,29},       // Row 3: T_bl
    {30,31,32,33,34,35,36,37,38,39}        // Row 4: T_br
};

static float _Wheel_Legged_Evaluate_Kij(uint8_t row_index, float l_l, float l_r) {
    const float *coeff = K_Fit_Coefficients[row_index];
    return coeff[0]
         + coeff[1] * l_l
         + coeff[2] * l_r
         + coeff[3] * l_l * l_l
         + coeff[4] * l_l * l_r
         + coeff[5] * l_r * l_r;
}

void Wheel_Legged_Compute_LQR_output(const WheelLeggedState *state, float l_l, float l_r, WheelLeggedInput *input) {
    const float x[10] = {
        state->s, state->ds, state->phi, state->dphi,
        state->theta_ll, state->dtheta_ll, state->theta_lr, state->dtheta_lr,
        state->theta_b, state->dtheta_b
    };

    float u[4] = {0.0f, 0.0f, 0.0f, 0.0f};

    for (int i = 0; i < 4; ++i) {
        for (int j = 0; j < 10; ++j) {
            float Kij = _Wheel_Legged_Evaluate_Kij(K_index_map[i][j], l_l, l_r);
            u[i] += -Kij * x[j];
        }
    }

    input->T_wl = u[0];
    input->T_wr = u[1];
    input->T_bl = u[2];
    input->T_br = u[3];
}